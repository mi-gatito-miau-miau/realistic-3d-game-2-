<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Epic 3D RPG</title>
<style>
body { margin:0; overflow:hidden; font-family:monospace; background:black; }
#hud {
  position:fixed; top:10px; left:10px;
  color:white; z-index:10;
}
#panel {
  position:fixed; right:10px; top:10px;
  background:#111; padding:10px;
  border:1px solid #444; color:white;
}
#home {
  position:fixed; bottom:10px; left:10px;
  background:#111; padding:10px;
  border:1px solid #444; color:white;
}
button { margin:3px; }
</style>
</head>
<body>

<div id="hud">
‚ù§Ô∏è HP: <span id="hp"></span><br>
üí∞ Gold: <span id="gold"></span><br>
‚öîÔ∏è Damage: <span id="dmg"></span><br>
üßü Stage: <span id="stage"></span><br>
üèÜ Score: <span id="score"></span>
</div>

<div id="panel">
<h4>üèÜ Leaderboard</h4>
<ol id="leaderboard"></ol>
</div>

<div id="home">
<h4>üè† Home Base</h4>
<button onclick="heal()">Heal</button><br>
<button onclick="upgrade('damage')">Upgrade Damage</button><br>
<button onclick="upgrade('speed')">Upgrade Speed</button><br>
<button onclick="upgrade('hp')">Upgrade HP</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
/* =====================================================
   CORE ENGINE
===================================================== */
const scene = new THREE.Scene();
scene.fog = new THREE.Fog(0x88aacc, 30, 300);

const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);
const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
renderer.shadowMap.enabled = true;
document.body.appendChild(renderer.domElement);

/* =====================================================
   LIGHTING
===================================================== */
const sun = new THREE.DirectionalLight(0xffffff,1.2);
sun.position.set(100,200,100);
sun.castShadow = true;
scene.add(sun);
scene.add(new THREE.AmbientLight(0x404040,0.6));

/* =====================================================
   WORLD
===================================================== */
const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(800,800,50,50).rotateX(-Math.PI/2),
  new THREE.MeshStandardMaterial({color:0x3e8e41})
);
ground.receiveShadow = true;
scene.add(ground);

/* =====================================================
   PLAYER
===================================================== */
const player = new THREE.Object3D();
scene.add(player);

let stats = {
  maxHP: 100,
  hp: 100,
  damage: 15,
  speed: 0.15,
  gold: 0,
  score: 0
};

const body = new THREE.Mesh(
  new THREE.CapsuleGeometry(0.5,1.2),
  new THREE.MeshStandardMaterial({color:0x3366ff})
);
body.castShadow = true;
player.add(body);
player.position.set(0,2,0);

/* =====================================================
   VISIBLE WEAPON (FIXED)
===================================================== */
const sword = new THREE.Mesh(
  new THREE.BoxGeometry(0.1,1.2,0.15),
  new THREE.MeshStandardMaterial({color:0xdddddd, metalness:0.8})
);
sword.position.set(0.7,0.6,0);
player.add(sword);

/* =====================================================
   ENEMIES & STAGES
===================================================== */
let enemies = [];
let stage = 1;

function spawnWave() {
  enemies.forEach(e=>scene.remove(e));
  enemies = [];

  const count = 5 + stage;
  for(let i=0;i<count;i++) spawnEnemy(false);

  if(stage % 3 === 0) spawnEnemy(true); // boss
}

function spawnEnemy(boss) {
  const size = boss ? 3 : 1;
  const enemy = new THREE.Mesh(
    new THREE.BoxGeometry(size,size*1.5,size),
    new THREE.MeshStandardMaterial({color: boss ? 0x550000 : 0xaa0000})
  );
  enemy.position.set(
    (Math.random()-0.5)*200,
    size,
    (Math.random()-0.5)*200
  );
  enemy.hp = boss ? 200 : 40;
  enemy.boss = boss;
  enemy.castShadow = true;
  scene.add(enemy);
  enemies.push(enemy);
}

/* =====================================================
   INPUT
===================================================== */
const keys = {};
addEventListener("keydown", e=>keys[e.key.toLowerCase()] = true);
addEventListener("keyup", e=>keys[e.key.toLowerCase()] = false);

/* =====================================================
   COMBAT (FIXED)
===================================================== */
let canAttack = true;
addEventListener("click", ()=>{
  if(!canAttack) return;
  canAttack = false;

  sword.rotation.x = -1;
  setTimeout(()=>sword.rotation.x = 0, 120);

  enemies.forEach(enemy=>{
    if(!enemy.parent) return;
    const d = player.position.distanceTo(enemy.position);
    if(d < 2.5){
      enemy.hp -= stats.damage;
      if(enemy.hp <= 0){
        scene.remove(enemy);
        stats.gold += enemy.boss ? 100 : 10;
        stats.score += enemy.boss ? 500 : 50;
      }
    }
  });

  setTimeout(()=>canAttack=true,300);
});

/* =====================================================
   HOME BASE SYSTEM
===================================================== */
function heal(){
  stats.hp = stats.maxHP;
}
function upgrade(type){
  if(stats.gold < 50) return;
  stats.gold -= 50;
  if(type==="damage") stats.damage += 5;
  if(type==="speed") stats.speed += 0.02;
  if(type==="hp") stats.maxHP += 20;
}

/* =====================================================
   LEADERBOARD
===================================================== */
function saveScore(){
  let board = JSON.parse(localStorage.getItem("leaderboard")||"[]");
  board.push(stats.score);
  board.sort((a,b)=>b-a);
  board = board.slice(0,5);
  localStorage.setItem("leaderboard", JSON.stringify(board));
}
function loadLeaderboard(){
  const board = JSON.parse(localStorage.getItem("leaderboard")||"[]");
  document.getElementById("leaderboard").innerHTML =
    board.map(s=>`<li>${s}</li>`).join("");
}

/* =====================================================
   GAME LOOP
===================================================== */
let velY = 0;
spawnWave();
loadLeaderboard();

function loop(){
  requestAnimationFrame(loop);

  if(keys.w) player.position.z -= stats.speed;
  if(keys.s) player.position.z += stats.speed;
  if(keys.a) player.position.x -= stats.speed;
  if(keys.d) player.position.x += stats.speed;

  velY -= 0.02;
  player.position.y += velY;
  if(player.position.y < 2){ player.position.y = 2; velY = 0; }

  enemies.forEach(enemy=>{
    if(!enemy.parent) return;
    enemy.lookAt(player.position);
    enemy.translateZ(enemy.boss ? 0.02 : 0.03);
    if(enemy.position.distanceTo(player.position) < 1.5){
      stats.hp -= enemy.boss ? 0.4 : 0.1;
    }
  });

  // STAGE COMPLETE (FIXED)
  if(enemies.every(e=>!e.parent)){
    stage++;
    stats.score += 200;
    spawnWave();
  }

  if(stats.hp <= 0){
    saveScore();
    stats.hp = stats.maxHP;
    stage = 1;
    stats.score = 0;
    spawnWave();
    loadLeaderboard();
  }

  camera.position.lerp(
    new THREE.Vector3(
      player.position.x,
      player.position.y + 8,
      player.position.z + 14
    ),0.08
  );
  camera.lookAt(player.position);

  document.getElementById("hp").textContent = Math.floor(stats.hp);
  document.getElementById("gold").textContent = stats.gold;
  document.getElementById("dmg").textContent = stats.damage;
  document.getElementById("stage").textContent = stage;
  document.getElementById("score").textContent = stats.score;

  renderer.render(scene,camera);
}
loop();

addEventListener("resize", ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>
</body>
</html>
